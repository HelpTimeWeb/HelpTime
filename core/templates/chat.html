{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpTime - Chat</title>
    <link rel="icon" href="{% static 'img/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand text-success d-flex align-items-center" href="{% url 'home' %}">
            <img src="{% static 'img/logo.png' %}" alt="Logo" width="30" height="30" class="me-2">
            HelpTime
        </a>
        <div class="d-flex">
            <a href="{% url 'services' %}" class="btn btn-outline-success me-2">Ver Servicios</a>
            {% if request.user.is_authenticated %}
                <a href="{% url 'profile' request.user.id %}" class="btn btn-outline-success me-2">Volver al Perfil</a>
                <a href="{% url 'logout' %}" class="btn btn-success">Cerrar Sesión</a>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-success">Iniciar Sesión</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            {% if chat_user %}
                <div class="card shadow">
                    <div class="card-header bg-success text-white d-flex align-items-center">
                        {% if chat_user.profile_image %}
                            <img src="{{ chat_user.profile_image.url }}" 
                                 class="rounded-circle me-2" style="width:40px;height:40px;" alt="Usuario">
                        {% else %}
                            <img src="https://via.placeholder.com/40" 
                                 class="rounded-circle me-2" style="width:40px;height:40px;" alt="Usuario">
                        {% endif %}
                        Chat con {{ chat_user.username }} (Ubicación: {{ chat_user.location|default:"No especificada" }})
                    </div>

                    <div class="card-body chat-box" style="height: 400px; overflow-y: scroll;">
                        {% for msg in messages %}
                            <div class="mb-2 {% if msg.sender == request.user %}text-end{% endif %}">
                                <strong>{{ msg.sender.username }}:</strong> {{ msg.content }}
                            </div>
                        {% empty %}
                            <p class="text-muted">No hay mensajes todavía</p>
                        {% endfor %}
                    </div>

                    <div class="card-footer">
                        <form method="POST" action="{% url 'send_message' chat_user.id %}">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" class="form-control" name="message" placeholder="Escribe un mensaje..." required>
                                <button class="btn btn-success" type="submit">Enviar</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info text-center">
                    ⚠️ No podés chatear contigo mismo.
                </div>
            {% endif %}

            <button onclick="history.back()" class="btn btn-secondary w-100 mt-2">Volver</button>
        </div>
    </div>
</div>

<footer class="text-center mt-5 mb-3 text-muted">
    <small>
        HelpTime no se hace responsable de conflictos entre usuarios. 
        Al usar este sitio aceptas nuestras <a href="{% url 'terms' %}">condiciones de uso</a>.
    </small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
